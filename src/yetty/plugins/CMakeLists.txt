# Plugin shared libraries - discovered at runtime via dlopen

# Common function to create a plugin shared library
function(add_yetty_plugin NAME)
    cmake_parse_arguments(PLUGIN "" "" "SOURCES;LIBS;INCLUDES" ${ARGN})

    add_library(${NAME}_plugin SHARED ${PLUGIN_SOURCES})

    target_include_directories(${NAME}_plugin PRIVATE
        ${CMAKE_SOURCE_DIR}/include
        ${CMAKE_SOURCE_DIR}/src
        ${PLUGIN_INCLUDES}
    )

    # Link against yetty_core (provides Font, FontManager, RichText, WebGPUContext)
    target_link_libraries(${NAME}_plugin PRIVATE
        yetty_core
        yaml-cpp
        ${PLUGIN_LIBS}
    )

    # Output to plugins directory
    set_target_properties(${NAME}_plugin PROPERTIES
        LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/plugins"
        OUTPUT_NAME "${NAME}"
        PREFIX ""  # No 'lib' prefix
    )

    # Ensure position independent code
    set_target_properties(${NAME}_plugin PROPERTIES POSITION_INDEPENDENT_CODE ON)
endfunction()

# shader plugin
add_yetty_plugin(shader
    SOURCES shader/shader.cpp
)

# ydraw plugin (2D/3D SDF rendering using core library)
add_yetty_plugin(ydraw
    SOURCES ydraw/ydraw.cpp
)

# rich-text plugin
add_yetty_plugin(rich-text
    SOURCES rich-text/rich-text.cpp
)

# image plugin
add_yetty_plugin(image
    SOURCES image/image.cpp
)

# plot plugin
add_yetty_plugin(plot
    SOURCES plot/plot.cpp
)

# piano plugin
add_subdirectory(piano)

# musical-score plugin
add_subdirectory(musical-score)

# markdown plugin
add_yetty_plugin(markdown
    SOURCES markdown/markdown.cpp
)

#-----------------------------------------------------------------------------
# ThorVG plugin - Vector graphics (SVG, Lottie animations)
#-----------------------------------------------------------------------------
option(YETTY_PLUGIN_THORVG "Build ThorVG plugin for SVG/Lottie support" OFF)

if(YETTY_PLUGIN_THORVG)
# Download ThorVG from GitHub release for reproducible builds
CPMAddPackage(
    NAME thorvg
    URL https://github.com/thorvg/thorvg/archive/refs/tags/v1.0-pre34.tar.gz
    DOWNLOAD_ONLY YES
)

if(thorvg_ADDED)
    # Build ThorVG as a static library from source files
    # We use WebGPU renderer for direct GPU rendering integration with yetty
    
    # Generate config.h for ThorVG (required by the library)
    # This replicates what meson's configure_file does
    set(THORVG_CONFIG_H_CONTENT
"// ThorVG Configuration Header - Generated by CMake
#ifndef _TVG_CONFIG_H_
#define _TVG_CONFIG_H_

#define THORVG_VERSION_STRING \"1.0.34\"

// Engine Support
#define THORVG_WG_RASTER_SUPPORT 1

// Loader Support  
#define THORVG_SVG_LOADER_SUPPORT 1
#define THORVG_LOTTIE_LOADER_SUPPORT 1

// Multi-threading disabled for simplicity
// #define THORVG_THREAD_SUPPORT 1

#endif // _TVG_CONFIG_H_
")
    file(WRITE "${thorvg_SOURCE_DIR}/src/common/config.h" "${THORVG_CONFIG_H_CONTENT}")
    
    # Collect ThorVG source files using GLOB
    file(GLOB THORVG_COMMON_SOURCES
        ${thorvg_SOURCE_DIR}/src/common/*.cpp
    )
    
    file(GLOB THORVG_RENDERER_SOURCES
        ${thorvg_SOURCE_DIR}/src/renderer/*.cpp
    )
    
    # WebGPU engine for native WebGPU rendering
    file(GLOB THORVG_WG_ENGINE_SOURCES
        ${thorvg_SOURCE_DIR}/src/renderer/wg_engine/*.cpp
    )
    
    file(GLOB THORVG_SVG_LOADER_SOURCES
        ${thorvg_SOURCE_DIR}/src/loaders/svg/*.cpp
    )
    
    file(GLOB THORVG_LOTTIE_LOADER_SOURCES
        ${thorvg_SOURCE_DIR}/src/loaders/lottie/*.cpp
    )
    
    file(GLOB THORVG_RAW_LOADER_SOURCES
        ${thorvg_SOURCE_DIR}/src/loaders/raw/*.cpp
    )
    
    set(THORVG_SOURCES
        ${THORVG_COMMON_SOURCES}
        ${THORVG_RENDERER_SOURCES}
        ${THORVG_WG_ENGINE_SOURCES}
        ${THORVG_SVG_LOADER_SOURCES}
        ${THORVG_LOTTIE_LOADER_SOURCES}
        ${THORVG_RAW_LOADER_SOURCES}
    )
    
    # Create thorvg library
    add_library(thorvg_lib STATIC ${THORVG_SOURCES})
    
    target_include_directories(thorvg_lib PUBLIC
        ${thorvg_SOURCE_DIR}/inc
    )
    
    target_include_directories(thorvg_lib PRIVATE
        ${thorvg_SOURCE_DIR}/src/common
        ${thorvg_SOURCE_DIR}/src/renderer
        ${thorvg_SOURCE_DIR}/src/renderer/wg_engine
        ${thorvg_SOURCE_DIR}/src/loaders/svg
        ${thorvg_SOURCE_DIR}/src/loaders/lottie
        ${thorvg_SOURCE_DIR}/src/loaders/lottie/rapidjson
        ${thorvg_SOURCE_DIR}/src/loaders/raw
    )
    
    # ThorVG configuration defines - using WebGPU renderer
    target_compile_definitions(thorvg_lib PRIVATE
        TVG_STATIC
    )
    
    # Link with WebGPU library (provided by yetty_cory)
    target_link_libraries(thorvg_lib PRIVATE webgpu)
    
    # Suppress warnings in third-party code
    target_compile_options(thorvg_lib PRIVATE -w)
    
    # Enable PIC for shared library plugin
    set_target_properties(thorvg_lib PROPERTIES POSITION_INDEPENDENT_CODE ON)
    
    # Create the thorvg plugin
    add_yetty_plugin(thorvg
        SOURCES thorvg/thorvg-plugin.cpp
        LIBS thorvg_lib
        INCLUDES ${thorvg_SOURCE_DIR}/inc
    )
    
    message(STATUS "ThorVG plugin: enabled (v1.0-pre34)")
endif()
else()
    message(STATUS "ThorVG plugin: disabled (set -DYETTY_PLUGIN_THORVG=ON to enable)")
endif()


#-----------------------------------------------------------------------------
# Python widget - statically linked into main executable (not a dynamic plugin)
# Python requires -force_load/--whole-archive so extension modules can resolve symbols
#-----------------------------------------------------------------------------
if(UNIX AND YETTY_PLUGIN_PYTHON)
    add_library(python_widget STATIC
        python/python.cpp
        python/yetty_wgpu.cpp
    )

    target_include_directories(python_widget PRIVATE
        ${CMAKE_SOURCE_DIR}/include
        ${CMAKE_SOURCE_DIR}/src
        ${PYTHON_EMBEDDED_INCLUDE_DIR}
    )

    target_link_libraries(python_widget PRIVATE yetty_core yaml-cpp)

    # Ensure Python is built before this
    add_dependencies(python_widget python_embedded)

    target_compile_definitions(python_widget PRIVATE
        CMAKE_BINARY_DIR="${CMAKE_BINARY_DIR}"
    )

    set_target_properties(python_widget PROPERTIES POSITION_INDEPENDENT_CODE ON)

    # Copy Python helper modules to build directory
    file(MAKE_DIRECTORY ${CMAKE_BINARY_DIR}/python)
    configure_file(
        ${CMAKE_CURRENT_SOURCE_DIR}/python/yetty_pygfx.py
        ${CMAKE_BINARY_DIR}/python/yetty_pygfx.py
        COPYONLY
    )
    configure_file(
        ${CMAKE_CURRENT_SOURCE_DIR}/python/init.py
        ${CMAKE_BINARY_DIR}/python/init.py
        COPYONLY
    )

    message(STATUS "Python widget: enabled (statically linked)")
else()
    message(STATUS "Python widget: disabled (set -DYETTY_PLUGIN_PYTHON=ON to enable)")
endif()


# pdf plugin - uses RichText for rendering (MuPDF - AGPL licensed)
if(TARGET mupdf)
    add_yetty_plugin(pdf
        SOURCES pdf/pdf.cpp
        LIBS mupdf
    )
    message(STATUS "pdf plugin: enabled (MuPDF - AGPL license)")
else()
    message(STATUS "pdf plugin: disabled (mupdf not found)")
endif()

# pdfium plugin - uses RichText for rendering (PDFium - BSD-3-Clause, MIT compatible)
if(TARGET pdfium_lib)
    add_yetty_plugin(pdfium
        SOURCES pdfium/pdfium.cpp
        LIBS pdfium_lib
    )
    message(STATUS "pdfium plugin: enabled (BSD-3-Clause license)")
else()
    message(STATUS "pdfium plugin: disabled (pdfium_lib not found)")
endif()

# video plugin (Unix only - FFmpeg build requires ./configure + make)
if(UNIX AND TARGET ffmpeg)
    add_yetty_plugin(video
        SOURCES video/video.cpp
        LIBS ffmpeg
    )
    message(STATUS "video plugin: enabled (FFmpeg)")
else()
    message(STATUS "video plugin: disabled (ffmpeg not found)")
endif()

# ymery plugin - ImGui/ImPlot scientific visualization (requires ymery-cpp)
if(TARGET ymery_lib)
    add_yetty_plugin(ymery
        SOURCES ymery/ymery.cpp
        LIBS ymery_lib
    )
    target_compile_definitions(ymery_plugin PRIVATE YETTY_YMERY_ENABLED=1)
    message(STATUS "ymery plugin: enabled")
else()
    message(STATUS "ymery plugin: disabled (ymery_lib not found)")
endif()
