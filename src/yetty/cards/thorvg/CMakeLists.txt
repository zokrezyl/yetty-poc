# ThorVG card - Vector graphics (SVG, Lottie animations, YAML)
# Uses ThorVG software renderer (SwCanvas) to render to CPU buffer,
# then uploads to textureData for GPU display via the texture card shader.

# Download ThorVG from GitHub release
CPMAddPackage(
    NAME thorvg
    URL https://github.com/thorvg/thorvg/archive/refs/tags/v1.0-pre34.tar.gz
    DOWNLOAD_ONLY YES
)

if(thorvg_ADDED)
    # Generate config.h for ThorVG (required by the library)
    set(THORVG_CONFIG_H_CONTENT
"// ThorVG Configuration Header - Generated by CMake
#ifndef _TVG_CONFIG_H_
#define _TVG_CONFIG_H_

#define THORVG_VERSION_STRING \"1.0.34\"

// Engine Support - Software renderer for CPU-side rendering
#define THORVG_SW_RASTER_SUPPORT 1

// Loader Support
#define THORVG_SVG_LOADER_SUPPORT 1
#define THORVG_LOTTIE_LOADER_SUPPORT 1

#endif // _TVG_CONFIG_H_
")
    file(WRITE "${thorvg_SOURCE_DIR}/src/common/config.h" "${THORVG_CONFIG_H_CONTENT}")

    # Collect ThorVG source files
    file(GLOB THORVG_COMMON_SOURCES
        ${thorvg_SOURCE_DIR}/src/common/*.cpp
    )

    file(GLOB THORVG_RENDERER_SOURCES
        ${thorvg_SOURCE_DIR}/src/renderer/*.cpp
    )

    # Software engine for CPU rendering to buffer
    file(GLOB THORVG_SW_ENGINE_SOURCES
        ${thorvg_SOURCE_DIR}/src/renderer/sw_engine/*.cpp
    )

    file(GLOB THORVG_SVG_LOADER_SOURCES
        ${thorvg_SOURCE_DIR}/src/loaders/svg/*.cpp
    )

    file(GLOB THORVG_LOTTIE_LOADER_SOURCES
        ${thorvg_SOURCE_DIR}/src/loaders/lottie/*.cpp
    )

    file(GLOB THORVG_RAW_LOADER_SOURCES
        ${thorvg_SOURCE_DIR}/src/loaders/raw/*.cpp
    )

    set(THORVG_SOURCES
        ${THORVG_COMMON_SOURCES}
        ${THORVG_RENDERER_SOURCES}
        ${THORVG_SW_ENGINE_SOURCES}
        ${THORVG_SVG_LOADER_SOURCES}
        ${THORVG_LOTTIE_LOADER_SOURCES}
        ${THORVG_RAW_LOADER_SOURCES}
    )

    # Create thorvg library (if not already defined by the plugin)
    if(NOT TARGET thorvg_sw_lib)
        add_library(thorvg_sw_lib STATIC ${THORVG_SOURCES})

        target_include_directories(thorvg_sw_lib PUBLIC
            ${thorvg_SOURCE_DIR}/inc
        )

        target_include_directories(thorvg_sw_lib PRIVATE
            ${thorvg_SOURCE_DIR}/src/common
            ${thorvg_SOURCE_DIR}/src/renderer
            ${thorvg_SOURCE_DIR}/src/renderer/sw_engine
            ${thorvg_SOURCE_DIR}/src/loaders/svg
            ${thorvg_SOURCE_DIR}/src/loaders/lottie
            ${thorvg_SOURCE_DIR}/src/loaders/lottie/rapidjson
            ${thorvg_SOURCE_DIR}/src/loaders/raw
        )

        target_compile_definitions(thorvg_sw_lib PRIVATE
            TVG_STATIC
        )

        # Suppress warnings in third-party code
        if(MSVC)
            target_compile_options(thorvg_sw_lib PRIVATE /w)
        else()
            target_compile_options(thorvg_sw_lib PRIVATE -w)
        endif()
    endif()

    # Add card sources to yetty target
    target_sources(yetty PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/thorvg.h
        ${CMAKE_CURRENT_SOURCE_DIR}/thorvg.cpp
    )

    # Link thorvg and get its include dirs
    target_link_libraries(yetty PRIVATE thorvg_sw_lib)

    message(STATUS "ThorVG card: enabled (v1.0-pre34, SW renderer)")
else()
    message(WARNING "ThorVG card: failed to download ThorVG")
endif()
