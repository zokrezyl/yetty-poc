<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>JSLinux VM Bridge</title>
    <style>
        body { margin: 0; padding: 0; }
        #term_container { display: none; }
    </style>
</head>
<body>
    <div id="term_container"></div>
    <script src="term-bridge.js"></script>
    <script>
        // Modified jslinux loader for bridge mode
        "use strict";

        var term, console_write1, console_resize_event;
        var net_state, net_write_packet, net_set_carrier;
        var fs_import_file;

        // Module object - Emscripten will populate this
        var Module = {};

        // Force setTimeout mode (mode 0) instead of rAF for faster input processing in iframe
        Module.postRun = function() {
            if (typeof Module.setMainLoopTiming === 'function') {
                Module.setMainLoopTiming(0, 0);
            }
        };

        // Logging helper
        function log(msg) {
            console.log("[vm-bridge] " + msg);
        }

        function term_handler(str) {
            var i;
            for(i = 0; i < str.length; i++) {
                var code = str.charCodeAt(i);
                if (code < 32) {
                    console.log("[vm-bridge] CTRL char " + code + " -> console_write1");
                }
                console_write1(code);
            }
        }

        function update_downloading(flag) {
            window.parent.postMessage({
                type: 'vm-downloading',
                ptyId: term ? term.ptyId : null,
                downloading: flag
            }, '*');
        }

        function get_params() {
            var params = {};
            var query = window.location.search.substring(1);
            var pairs = query.split("&");
            for (var i = 0; i < pairs.length; i++) {
                var pair = pairs[i].split("=");
                params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
            }
            return params;
        }

        function start_vm() {
            var params = get_params();
            var cpu = params["cpu"] || "x86_64";
            var url = params["url"] || "alpine-x86_64.cfg";
            var mem = parseInt(params["mem"]) || 256;
            var cols = parseInt(params["cols"]) || 80;
            var rows = parseInt(params["rows"]) || 25;

            // Create terminal bridge
            term = new Term({
                cols: cols,
                rows: rows,
                scrollback: 0
            });
            term.setKeyHandler(term_handler);
            term.open(document.getElementById("term_container"));

            // Determine emulator file
            var vm_file;
            switch(cpu) {
                case "x86":
                    vm_file = "x86emu";
                    break;
                case "x86_64":
                    vm_file = "x86_64emu";
                    break;
                case "riscv64":
                    vm_file = "riscvemu64";
                    break;
                case "riscv32":
                    vm_file = "riscvemu32";
                    break;
                default:
                    term.write("Error: Unknown cpu: " + cpu + "\r\n");
                    return;
            }
            var vm_url = vm_file + "-wasm.js";
            term.write("Loading " + vm_url + "...\r\n");

            var cfg_url = new URL(url, window.location.href).href;

            Module.preRun = function() {
                initVM(cfg_url, mem, cols, rows);
            };

            var script = document.createElement('script');
            script.src = vm_url;
            script.onerror = function(e) {
                term.write("Error loading emulator: " + vm_url + "\r\n");
            };
            document.body.appendChild(script);
        }

        function initVM(cfg_url, mem, cols, rows) {
            try {
                console_write1 = Module.cwrap('console_queue_char', null, ['number']);
                fs_import_file = Module.cwrap('fs_import_file', null, ['string', 'number', 'number']);
                net_write_packet = Module.cwrap('net_write_packet', null, ['number', 'number']);
                net_set_carrier = Module.cwrap('net_set_carrier', null, ['number']);
                console_resize_event = Module.cwrap('console_resize_event', null, []);

                // Set up resize handler so VM kernel gets notified of terminal size changes
                term.setResizeHandler(function(cols, rows) {
                    if (console_resize_event) {
                        console_resize_event();
                    }
                });
            } catch(e) {
                term.write("Error wrapping functions: " + e + "\r\n");
                return;
            }

            term.write("Starting VM...\r\n");

            try {
                Module.ccall('vm_start', null,
                    ['string', 'number', 'string', 'string', 'number', 'number', 'number', 'string'],
                    [cfg_url, mem, "", "", 0, 0, 0, ""]);
                // Trigger initial resize after VM starts
                setTimeout(function() { console_resize_event(); }, 1000);
            } catch(e) {
                term.write("Error starting VM: " + e + "\r\n");
            }
        }

        // Handle messages from parent for file import and resize
        window.addEventListener('message', function(e) {
            if (e.data.type === 'term-resize') {
                if (console_resize_event) {
                    console_resize_event();
                }
            }
            if (e.data.type === 'import-file' && fs_import_file) {
                var path = e.data.path;
                var data = e.data.data;
                var ptr = Module._malloc(data.length);
                Module.HEAPU8.set(data, ptr);
                fs_import_file(path, ptr, data.length);
                Module._free(ptr);
                window.parent.postMessage({
                    type: 'file-imported',
                    path: path,
                    size: data.length
                }, '*');
            }
        });

        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                start_vm();
            });
        } else {
            start_vm();
        }
    </script>
</body>
</html>
